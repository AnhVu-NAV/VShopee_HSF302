<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:fragment="head">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VShopper</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Theme CSS -->
    <link id="theme-stylesheet" rel="stylesheet" th:href="@{/css/light-theme.css}">
</head>
<style>
    #chat-body .user-message {
        background-color: #0d6efd;
        color: white;
        padding: 6px 10px;
        border-radius: 10px;
        text-align: right;
        margin-bottom: 6px;
        max-width: 100%;
        word-wrap: break-word;
        white-space: pre-wrap;
    }

    #chat-body .bot-message {
        background-color: #f1f1f1;
        color: #000;
        padding: 6px 10px;
        border-radius: 10px;
        margin-bottom: 6px;
        max-width: 100%;
        word-wrap: break-word;
        white-space: pre-wrap;
    }
</style>
<body id="page-body" class="bg-light text-dark d-flex flex-column min-vh-100">

<!-- ‚úÖ Navbar Fragment -->
<nav th:fragment="navbar" class="navbar navbar-expand-lg navbar-dark bg-success">
    <div class="container">
        <!-- N·∫øu l√† ADMIN -->
        <a class="navbar-brand fw-bold"
           th:if="${#authorization.expression('isAuthenticated()') and #authentication.principal.user.role.name == 'admin'}"
           th:href="@{/admin}">VShopper Admin</a>

        <!-- N·∫øu l√† CUSTOMER -->
        <a class="navbar-brand fw-bold"
           th:if="${#authorization.expression('isAuthenticated()') and #authentication.principal.user.role.name == 'customer'}"
           th:href="@{/products}">üõç VShopper</a>

        <!-- N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p -->
        <a class="navbar-brand fw-bold" th:if="${#authorization.expression('!isAuthenticated()')}" th:href="@{/}">üõç
            VShopper</a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <!-- Chung cho m·ªçi ng∆∞·ªùi -->
                <li class="nav-item"><a class="nav-link" th:href="@{/products}">S·∫£n ph·∫©m</a></li>

                <!-- Ch·ªâ hi·ªán khi l√† CUSTOMER -->
                <!--                <li th:if="${#authorization.expression('isAuthenticated()') and #authentication.principal.user.role.name == 'customer'}">-->
                <!--                <a class="nav-link" th:href="@{/cart}">Gi·ªè h√†ng</a>-->
                <!--                </li>-->
                <li th:if="${#authorization.expression('isAuthenticated()') and #authentication.principal.user.role.name == 'customer'}">
                    <a class="nav-link" th:href="@{/wishlist}">Y√™u th√≠ch</a>
                </li>
                <li th:if="${#authorization.expression('isAuthenticated()') and #authentication.principal.user.role.name == 'customer'}">
                    <a class="nav-link" th:href="@{/my-orders}">ƒê∆°n h√†ng</a>
                </li>

                <!-- Ch·ªâ hi·ªán khi l√† ADMIN -->
                <li th:if="${#authorization.expression('isAuthenticated()') and #authentication.principal.user.role.name == 'admin'}">
                    <a class="nav-link fw-bold" href="/admin/report">üìà Doanh thu</a>
                </li>
                <li th:if="${#authorization.expression('isAuthenticated()') and #authentication.principal.user.role.name == 'admin'}">
                    <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">Qu·∫£n l√Ω</a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" th:href="@{/admin/products}">Qu·∫£n l√Ω s·∫£n ph·∫©m</a></li>
                        <li><a class="dropdown-item" th:href="@{/admin/orders}">Qu·∫£n l√Ω ƒë∆°n h√†ng</a></li>
                        <li><a class="dropdown-item" th:href="@{/admin/users}">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</a></li>
                        <li><a class="dropdown-item" th:href="@{/admin/reviews}">Qu·∫£n l√Ω ƒë√°nh gi√°</a></li>
                        <li><a class="dropdown-item" th:href="@{/admin/brands}">Qu·∫£n l√Ω th∆∞∆°ng hi·ªáu</a></li>
                    </ul>
                </li>
            </ul>

            <ul class="navbar-nav ms-auto align-items-center">
                <!-- üåó N√∫t chuy·ªÉn theme -->
                <li class="nav-item me-2">
                    <button id="theme-toggle" class="btn btn-sm btn-light" onclick="toggleTheme()">üåó</button>
                </li>

                <!-- üõí N√∫t gi·ªè h√†ng hi·ªÉn th·ªã badge -->
                <li th:if="${#authorization.expression('isAuthenticated()') and #authentication.principal.user.role.name == 'customer'}"
                    class="nav-item me-3">
                    <a th:href="@{/cart}" class="btn btn-light position-relative">
                        üõí
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                              th:text="${cartCount > 0 ? cartCount : ''}"
                              th:if="${cartCount > 0}">0</span>
                    </a>
                </li>

                <!-- üëã User dropdown -->
                <li class="nav-item dropdown" th:if="${#authorization.expression('isAuthenticated()')}">
                    <a class="btn btn-light dropdown-toggle" href="#" role="button" id="userDropdown"
                       data-bs-toggle="dropdown" aria-expanded="false">
                        üëã <span th:text="${#authentication.principal.user.fullname}">User</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li><a class="dropdown-item" th:href="@{/profile}">H·ªì s∆° c√° nh√¢n</a></li>
                        <li><a class="dropdown-item" th:href="@{/logout}">ƒêƒÉng xu·∫•t</a></li>
                    </ul>
                </li>

                <!-- N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p -->
                <li class="nav-item" th:if="${#authorization.expression('!isAuthenticated()')}">
                    <a class="btn btn-outline-light" th:href="@{/login}">ƒêƒÉng nh·∫≠p</a>
                </li>
            </ul>

        </div>
    </div>
</nav>

<main class="flex-fill container py-4" th:fragment="main">
    <!-- N·ªôi dung trang con s·∫Ω v√†o ƒë√¢y -->
</main>


<!-- ‚úÖ Footer Fragment -->
<footer th:fragment="footer" class="bg-light text-center text-muted py-3 mt-5 mt-auto">
    <small>¬© 2025 VShopper. All rights reserved.</small>
</footer>

<!-- ‚úÖ Script Fragment -->
<div th:fragment="script">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function applyTheme(theme) {
            const body = document.getElementById("page-body");
            const themeLink = document.getElementById("theme-stylesheet");

            if (theme === "dark") {
                body.classList.remove("bg-light", "text-dark");
                body.classList.add("bg-dark", "text-light");
                themeLink.href = "/css/dark-theme.css";
            } else {
                body.classList.remove("bg-dark", "text-light");
                body.classList.add("bg-light", "text-dark");
                themeLink.href = "/css/light-theme.css";
            }
        }

        function toggleTheme() {
            const currentTheme = localStorage.getItem("theme") === "dark" ? "light" : "dark";
            localStorage.setItem("theme", currentTheme);
            applyTheme(currentTheme);
        }

        document.addEventListener("DOMContentLoaded", () => {
            const savedTheme = localStorage.getItem("theme") || "light";
            applyTheme(savedTheme);
        });
    </script>

<!--    //chatbot-->
    <script>
        function toggleChat() {
            const popup = document.getElementById('chatbot-popup');
            popup.style.display = (popup.style.display === 'none') ? 'block' : 'none';
        }

        async function sendMessage(event) {
            event.preventDefault();
            const input = document.getElementById("chat-input");
            const message = input.value.trim();
            if (!message) return;

            const chatBody = document.getElementById("chat-body");
            chatBody.innerHTML += `<div class='user-message'>${message}</div>`;

            input.value = "";

            try {
                const res = await fetch('/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message})
                });
                const data = await res.json();

                chatBody.innerHTML += `<div class='bot-message'>${data.response}</div>`;
                chatBody.scrollTop = chatBody.scrollHeight;
            } catch (err) {
                chatBody.innerHTML += `<div class='mb-1 text-danger'>L·ªói khi g·ª≠i tin nh·∫Øn.</div>`;
            }
        }
    </script>
</div>

</body>
</html>
